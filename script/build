#!/bin/sh
#
########################################################################
# Integration Build Script
#  $1 = all (Run integration tests)
#
#  Maintainer: id774 <idnanashi@gmail.com>
#
#  v1.2 6/16,2012
#       Add all option for integration tests.
#  v1.1 6/14,2012
#       Correspond to unscaffold subcommand.
#  v1.0 3/16,2012
#       First.
########################################################################

kickstart() {
    export RACK_ROOT="."
    export RACK_ENV="test"
    export DATABASE_URL="$RACK_ROOT/db"
    ruby -v
    test_config log info started.
}

exec_rspec() {
    $RACK_ROOT/bin/automatic -v
    $RACK_ROOT/script/bootstrap
    bundle exec $RACK_ROOT/bin/rake simplecov
}

run_test() {
    while [ $# -gt 0 ]
    do
        $RACK_ROOT/bin/automatic -c $1
        test_config log info $?
        shift
    done
}

load_tests() {
    for YAML_FILE in "$RACK_ROOT/test/integration/test_*.yml"
    do
        run_test $YAML_FILE
    done
    unset YAML_FILE
}

test_config() {
    $RACK_ROOT/bin/automatic-config $*
}

test_scaffold() {
    test_config scaffold
    test_config unscaffold
}

added_tests() {
    test -f $HOME/.automatic || test_scaffold
    test_config autodiscovery http://blog.id774.net/blogs/
    test_config opmlparser "$RACK_ROOT/test/fixtures/sampleOPML.xml"
    test_config feedparser http://blog.id774.net/blogs/feed/ > /dev/null
    test_config log info finished.
}

integration() {
    load_tests
    added_tests
}

main() {
    kickstart
    exec_rspec
    test -n "$1" && integration
}

set -ex
main $*
